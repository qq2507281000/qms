<!DOCTYPE html>
<html lang="zh" xmlns:th="http://www.thymeleaf.org" >
<head>
    <th:block th:include="include :: header('修改课程基本信息')" />
    <th:block th:include="include :: summernote-css" />
    <th:block th:include="include :: bootstrap-fileinput-css" />
    <th:block th:include="include :: select2-css" />
</head>
<body class="white-bg">
    <div class="wrapper wrapper-content animated fadeInRight ibox-content">
        <div class="row">
            <div class="col-sm-12">
                <div class="ibox float-e-margins">
                    <div class="ibox-title">
                        <h5>修改课程基本信息</h5>
                    </div>
                    <div class="ibox-content">

                        <form class="form-horizontal m" id="form-courses-edit" th:object="${tShopCourses}">
                            <input name="id" th:field="*{id}" type="hidden">
                            <div class="form-group">
                                <label class="col-sm-2 control-label">商家名称</label>
                                <div class="col-sm-10">
                                    <select class='form-control' id="shopId" name='shopId' style="width: 100%" required>
                                        <option value="">---请选择---</option>
                                        <option th:each="column : ${shop}" th:text="${column.name}" th:value="${column.id}" th:field="*{shopId}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">课程标题：</label>
                                <div class="col-sm-10">
                                    <input name="title" th:field="*{title}" class="form-control" type="text">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">课程副标题</label>
                                <div class="col-sm-10">
                                    <input type="text" name="subTitle" th:field="*{subTitle}" placeholder="请输入课程副标题" class="form-control">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">课程分类</label>
                                <div class="col-sm-10">
                                    <select class='form-control' id="categoryId" name='categoryId' style="width: 100%" required>
                                        <option value="">---请选择---</option>
                                        <option th:each="column : ${categories}" th:text="${column.name}" th:value="${column.id}" th:field="*{categoryId}"></option>
                                    </select>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">库存数量：</label>
                                <div class="col-sm-10">
                                    <input name="salesCount" th:field="*{salesCount}" class="form-control" type="text">
                                    <span class="help-block m-b-none">库存数量为-1的情况下，则不限制销售数量。</span>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">课程排序：</label>
                                <div class="col-sm-10">
                                    <input name="sortKey" th:field="*{sortKey}" class="form-control" type="text">
                                </div>
                            </div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">课程轮播图片</label>
                                <div class="col-sm-10">
                                    <div id="imgUploadPanel">
                                        <input id="imgUpload" type="file" multiple />
                                        <input id="imgUploadFileId" th:type="hidden" />
                                    </div>
                                    <input id="img" type="hidden" />
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">是否推荐：</label>
                                <div class="col-sm-10">
                                    <div class="radio-box" th:each="dict : ${@dict.getType('suggest')}">
                                        <input type="radio" th:id="${dict.dictCode}" name="suggest" th:value="${dict.dictValue}" th:checked="${dict.default}" th:field="*{suggest}">
                                        <label th:for="${dict.dictCode}" th:text="${dict.dictLabel}"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">是否可用：</label>
                                <div class="col-sm-10">
                                    <div class="radio-box" th:each="dict : ${@dict.getType('available')}">
                                        <input type="radio" th:id="${dict.dictCode}" name="available" th:value="${dict.dictValue}" th:checked="${dict.default}" th:field="*{available}">
                                        <label th:for="${dict.dictCode}" th:text="${dict.dictLabel}"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <label class="col-sm-2 control-label">是否使用优惠券：</label>
                                <div class="col-sm-10">
                                    <div class="radio-box" th:each="dict : ${@dict.getType('useDiscount')}">
                                        <input type="radio" th:id="${dict.dictCode}" name="useDiscount" th:value="${dict.dictValue}" th:checked="${dict.default}" th:field="*{useDiscount}">
                                        <label th:for="${dict.dictCode}" th:text="${dict.dictLabel}"></label>
                                    </div>
                                </div>
                            </div>
                            <div class="hr-line-dashed"></div>
                            <div class="form-group">
                                <h4 class="form-header h4">课程详情</h4>
                                <div id="summernote" class="summernote">

                                </div>
                            </div>
                        </form>

                        <div class="row text-center" style="padding:15px;">
                            <button class="btn btn-primary btn-xl" onclick="submitHandler()"><i class="fa fa-save"></i> 保存</button>
                            <button class="btn btn-danger btn-xl" onclick="closeItem()"><i class="fa fa-close"></i> 取消</button>
                        </div>

                        <div class="row">
                            <div class="btn-group-sm" id="toolbar" role="group">
                                <a class="btn btn-success" th:onclick="$.operate.add([[${tShopCourses.id}]])" shiro:hasPermission="shop:price:add">
                                    <i class="fa fa-plus"></i> 添加
                                </a>
                                <a class="btn btn-primary single disabled" onclick="$.operate.edit()" shiro:hasPermission="shop:price:edit">
                                    <i class="fa fa-edit"></i> 修改
                                </a>
                                <a class="btn btn-danger multiple disabled" onclick="$.operate.removeAll()" shiro:hasPermission="shop:price:remove">
                                    <i class="fa fa-remove"></i> 删除
                                </a>
                                <!--                <a class="btn btn-warning" onclick="$.table.exportExcel()" shiro:hasPermission="shop:price:export">-->
                                <!--                    <i class="fa fa-download"></i> 导出-->
                                <!--                 </a>-->
                            </div>
                            <div class="col-sm-12 select-table table-striped">
                                <table id="bootstrap-table" data-mobile-responsive="true"></table>
                            </div>
                        </div>
                </div>
            </div>
            </div>
        </div>
    </div>
    <th:block th:include="include :: footer" />
    <th:block th:include="include :: summernote-js" />
    <th:block th:include="include :: select2-js" />
    <th:block th:include="include :: bootstrap-fileinput-js" />

    <script th:inline="javascript">
        /*<![CDATA[*/

        var htmlContent = [[${tShopCourses.contentHtml}]];
        console.log("------>>>"+htmlContent);

        var imgs = [[${coursesImages}]];
        console.log(imgs);
        /*]]>*/

        var editFlag = [[${@permission.hasPermi('shop:price:edit')}]];
        var removeFlag = [[${@permission.hasPermi('shop:price:remove')}]];
        var specialPriceLevel = [[${@dict.getType('special_price_level')}]];


    </script>

    <script type="text/javascript">
        var prefix = "/shop/courses";
        var prefixPrice = "/shop/price";
        var id = $('#id').val();
        var listUrl = prefixPrice + "/list";
        if($.common.isNotEmpty(id)){
            listUrl = listUrl + "?shop-id=" + id;
        }

        $("#form-courses-edit").validate({
            focusCleanup: true
        });

        //富文本输入框
        $(document).ready(function () {
            $('.summernote').summernote({
                lang: 'zh-CN',
                placeholder: '请输入课程详细信息。',
                // 对话框显示在body而非summernote
                dialogsInBody: true,
                dialogsFade:true,
                width:360,
                height: 450,
                callbacks: {
                    onImageUpload: function(files, editor, welEditable) {
                        var files_length = files.length;
                        //此处循环上传每一个图片
                        for(var i=0;i<files_length;i++){
                            sendFile(files[i], editor, welEditable);
                        }
                    },
                }
            });
            $('.summernote').summernote('code',htmlContent);
        });

        function sendFile(files,editor,welEditable) {
            var data = new FormData();
            data.append("file", files);
            data.append("type", "img");

            $.ajax({
                data : data,
                type : "POST",
                url : "/file/summernote/upload",    // 图片上传出来的url，返回的是图片上传后的路径，http格式
                cache : false,
                contentType : false,
                processData : false,
                //dataType : "json",
                success: function(result) {//data是返回的hash,key之类的值，key是定义的文件名
                    console.log(result)
                    $('.summernote').summernote('insertImage', "https://web.hdpi.ttonservice.com/resource-file/" + result.data);
                },
                error:function(){
                    alert("上传失败");
                }
            });
        }


        $(function(){

            var images = new Array();
            var bimg = "";

            for(i=0;i<imgs.length;i++){
                var url = imgs[i].imageUrl;
                console.log(url);
                images.push("/resource-file/" + url);
                if($.common.isEmpty(bimg)){
                    bimg = url;
                }
                else{
                    bimg = bimg + "," + url;
                }
            }

            console.log(images);

            $('#img').val(bimg);

            $("#imgUpload").fileinput({
                // 'theme': 'explorer-fas',
                uploadUrl: '/file/upload',
                overwriteInitial: false,
                initialPreviewAsData: true,
                maxFileCount: 8,
                initialPreview: images
            });

            $("#imgUpload").on("fileuploaded", function (event, data, previewId, index) {
                // var content = JSON.stringify(data);
                var code = data.response.code;
                var message = data.response.message;
                var list = data.response.data;
                if(code == 0){
                    //文件上传成功。
                    $.modal.alertSuccess(message);
                    var fileName = list[0];
                    if($.common.isEmpty($('#img').val())){
                        $("#img").val(fileName);
                    }
                    else{
                        var url = $("#img").val();
                        url += "|" + fileName;
                        $("#img").val(url);
                    }
                }
                else if(code == 500){
                    $.modal.alertError(message);
                }
                // console.log(content);
                console.log(code);
                console.log(message);
                console.log(list[0]);
            })

            var options = {
                url: listUrl,
                createUrl: prefixPrice + "/add/{id}",
                updateUrl: prefixPrice + "/edit/{id}",
                removeUrl: prefixPrice + "/remove",
                exportUrl: prefixPrice + "/export",
                modalName: "课程价格信息",
                columns: [{
                    checkbox: true
                },
                    {
                        field : 'id',
                        title : '限制每人购买数量，-1为不限制。',
                        visible: false
                    },
                    {
                        field : 'shopName',
                        align: 'center',
                        title : '商家名称'
                    },
                    {
                        field : 'title',
                        align: 'center',
                        title : '课程名称'
                    },
                    {
                        field : 'price',
                        align: 'center',
                        title : '默认基准价格'
                    },
                    {
                        field : 'subTitleOne',
                        align: 'center',
                        title : '一级标题',
                        formatter: function(value, row, index) {
                            return $.table.tooltip(value);
                        }
                    },
                    {
                        field : 'perLimitBuy',
                        align: 'center',
                        title : '限制每人购买数量'
                    },
                    {
                        field : 'specialPriceLevel',
                        align: 'center',
                        title : '是否VIP价格',
                        formatter: function(value, row, index) {
                        return $.table.selectDictLabel(specialPriceLevel, value);
                    }
                    },
                    {
                        title: '操作',
                        align: 'center',
                        formatter: function(value, row, index) {
                            var actions = [];
                            actions.push('<a class="btn btn-success btn-xs ' + editFlag + '" href="javascript:void(0)" onclick="$.operate.edit(\'' + row.id + '\')"><i class="fa fa-edit"></i>编辑</a> ');
                            actions.push('<a class="btn btn-danger btn-xs ' + removeFlag + '" href="javascript:void(0)" onclick="$.operate.remove(\'' + row.id + '\')"><i class="fa fa-remove"></i>删除</a>');
                            return actions.join('');
                        }
                    }]
            };
            $.table.init(options);
        });

        function submitHandler() {

            var note = $('.summernote').summernote('code');
            if($.common.isEmpty($('#img').val())){
                $.modal.alertError("请先上传图片文件。");
                return;
            }

            if ($.validate.form()) {
                var data = $("#form-courses-edit").serializeArray();
                data.push({"name": "contentHtml", "value": note});
                data.push({"name": "params[img]", "value": $('#img').val()})
                console.log(JSON.stringify(data));
                $.operate.saveTab(prefix + "/edit", data);

            }
        }

    </script>
</body>
</html>